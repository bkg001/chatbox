<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #e5ddd5;
    }

    .chat-header {
      background-color: #075e54;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header span {
      font-size: 18px;
    }

    .chat-header button {
      background: white;
      color: #075e54;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-weight: bold;
      cursor: pointer;
    }

    #chatBox {
      height: 70vh;
      overflow-y: auto;
      padding: 10px;
      background-color: #ece5dd;
    }

    .message {
      background-color: #dcf8c6;
      margin: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      position: relative;
    }

    .message img {
      max-width: 100%;
      border-radius: 8px;
    }

    .message.user {
      background-color: #fff;
      align-self: flex-end;
      text-align: right;
    }

    .message.system {
      background-color: #ffeeba;
      text-align: center;
    }

    .delete-btn {
      position: absolute;
      top: 2px;
      right: 4px;
      font-size: 14px;
      color: red;
      cursor: pointer;
      display: none;
    }

    .message:hover .delete-btn {
      display: block;
    }

    .input-container {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-top: 1px solid #ccc;
    }

    .attachment-button {
      font-size: 22px;
      cursor: pointer;
      margin-right: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }

    #sendButton {
      background-color: #25d366;
      color: white;
      border: none;
      border-radius: 50%;
      padding: 10px 15px;
      margin-left: 10px;
      font-size: 18px;
      cursor: pointer;
    }

    #membersModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      max-height: 70%;
      overflow-y: auto;
      background-color: white;
      border: 2px solid #075e54;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
    }

    .member {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .dot {
      height: 10px;
      width: 10px;
      margin-right: 10px;
      border-radius: 50%;
    }

    .online {
      background-color: green;
    }

    .offline {
      background-color: gray;
    }

    .clear-chat-btn {
      margin: 10px;
      background-color: red;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="chat-header">
    <span>{{ name }} @ {{ room_id }}</span>
    <div>
      <button onclick="showMembers()">Members</button>
      <button onclick="location.href='/'">Logout</button>
    </div>
  </div>

  <div id="chatBox"></div>

  <button class="clear-chat-btn" onclick="clearMyChat()">🧹 CLEAR CHAT</button>

  <div class="input-container">
    <label for="fileInput" class="attachment-button">📎</label>
    <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.zip" />
    <input id="messageInput" type="text" placeholder="Type a message...">
    <button id="sendButton">➤</button>
  </div>

  <div id="membersModal">
    <h3>Room Members</h3>
    <div id="membersList"></div>
    <button onclick="hideMembers()">Close</button>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    const name = "{{ name }}";
    const room = "{{ room_id }}";
    const chatBox = document.getElementById('chatBox');

    socket.emit('join', { name, room });

    socket.on('message', data => {
      const div = document.createElement('div');
      div.className = 'message';

      if (data.user === 'System') div.classList.add('system');
      if (data.user === name) div.classList.add('user');

      if (data.type === 'text') {
        div.innerHTML = `<b>${data.user}</b>: ${data.text}
        <div class="delete-btn" onclick="deleteMessage('${data.timestamp}')">✖</div>`;
      } else if (data.type === 'image' || data.type === 'sticker') {
        div.innerHTML = `<b>${data.user}</b>:<br><img src="${data.image_url}">
        <div class="delete-btn" onclick="deleteMessage('${data.timestamp}')">✖</div>`;
      } else if (data.type === 'document' || data.type === 'file') {
        const fileName = data.image_url.split('/').pop();
        div.innerHTML = `<b>${data.user}</b>:<br><a href="${data.image_url}" download target="_blank">📄 ${fileName}</a>
        <div class="delete-btn" onclick="deleteMessage('${data.timestamp}')">✖</div>`;
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById('sendButton').onclick = sendMessage;
    document.getElementById('messageInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const msg = document.getElementById('messageInput').value.trim();
      if (msg) {
        socket.emit('send_message', { name, room, message: msg, type: 'text' });
        document.getElementById('messageInput').value = '';
      }
    }

    document.getElementById('fileInput').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('image', file);

      const res = await fetch('/upload_image', {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      if (result.url) {
        const ext = file.name.split('.').pop().toLowerCase();
        const docExt = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt', 'zip'];
        const type = docExt.includes(ext) ? 'document' : 'image';

        socket.emit('send_message', {
          name,
          room,
          type,
          image_url: result.url
        });
      }
    });

    function deleteMessage(timestamp) {
      fetch('/delete_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room, timestamp })
      }).then(() => location.reload());
    }

    function clearMyChat() {
      if (confirm("Are you sure you want to clear this room's chat history?")) {
        fetch('/clear_room_chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ room })
        }).then(res => {
          if (res.ok) {
            alert("✅ Chat cleared!");
            location.reload();
          } else {
            alert("❌ Failed to clear chat.");
          }
        });
      }
    }

    function showMembers() {
      fetch(`/get_members/${room}`).then(res => res.json()).then(data => {
        const membersDiv = document.getElementById('membersList');
        membersDiv.innerHTML = '';
        data.members.forEach(m => {
          const row = document.createElement('div');
          row.className = 'member';
          row.innerHTML = `<div class="dot ${m.online ? 'online' : 'offline'}"></div> ${m.name}`;
          membersDiv.appendChild(row);
        });
        document.getElementById('membersModal').style.display = 'block';
      });
    }

    function hideMembers() {
      document.getElementById('membersModal').style.display = 'none';
    }
  </script>
</body>
</html>
